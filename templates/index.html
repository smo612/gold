<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>金幣與補品計算器</title>
    <style>
        body {
            font-family: "微軟正黑體", sans-serif;
            background-color: #f9f9f9;
            padding: 40px;
            display: flex;
            justify-content: center;
            font-size: 20px; /* 字體放大 */
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 980px;
        }

        .flex-row {
            display: flex;
            justify-content: space-between;
        }

        .left-col, .right-col {
            width: 48%;
        }

        .potion-block {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .potion-block img {
            width: 64px;
            height: 64px;
            margin-right: 15px;
        }

        .left-col img {
            width: 36px;
            height: 36px;
            vertical-align: middle;
            margin-right: 8px;
        }

        input[type="number"] {
            width: 80px;
            margin: 3px 6px;
            font-size: 18px;
        }

        button {
            background: #4CAF50;
            color: white;
            padding: 10px 25px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 25px;
            font-size: 18px;
        }

        .hidden {
            display: none;
        }

        ul {
            padding-left: 25px;
        }

        .result {
            margin-top: 35px;
        }

        .result h3 {
            margin-top: 15px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>💰 金幣與補品計算器</h1>
    <form method="POST">
        <div class="flex-row">
            <div class="left-col">
                <label>起始金幣：
                    <input type="number" name="gold_start" value="{{ request.form.gold_start or '' }}" required>
                </label><br>
                <label>目前金幣：
                    <input type="number" name="gold_end" value="{{ request.form.gold_end or '' }}" required>
                </label>
                <hr>
                <p>請選擇兩種使用的藥水（必選兩項）：</p>
                {% set selected = request.form.getlist('potions') %}
                <label><input type="checkbox" name="potions" value="red" {% if 'red' in selected %}checked{% endif %} onchange="updatePotionInputs()"><img src="/static/docs/red.png">紅色藥水</label><br>
                <label><input type="checkbox" name="potions" value="orange" {% if 'orange' in selected %}checked{% endif %} onchange="updatePotionInputs()"><img src="/static/docs/orange.png">橘色藥水</label><br>
                <label><input type="checkbox" name="potions" value="white" {% if 'white' in selected %}checked{% endif %} onchange="updatePotionInputs()"><img src="/static/docs/white.png">白色藥水</label><br>
                <label><input type="checkbox" name="potions" value="blue" {% if 'blue' in selected %}checked{% endif %} onchange="updatePotionInputs()"><img src="/static/docs/blue.png">藍色藥水</label><br>
                <label><input type="checkbox" name="potions" value="energy" {% if 'energy' in selected %}checked{% endif %} onchange="updatePotionInputs()"><img src="/static/docs/vigor.png">活力藥水</label><br>

                <button type="submit">📊 計算</button>
                <button type="reset">🔄 重設</button>
            </div>

            <div class="right-col" id="potion-input-area">
                <!-- JS 生成藥水欄位 -->
            </div>
        </div>
    </form>

    {% if result %}
    <div class="result">
        <h2>🔍 計算結果：</h2>
        <ul>
            <li>金幣增加：{{ result.gold_gain }} 金幣</li>
            <li>總成本：{{ result.total_cost }} 金幣</li>
            <li>淨利：{{ result.net_profit }} 金幣</li>
        </ul>
        <h3>{{ result.status }}</h3>
        <hr>
        <h4>各補品花費：</h4>
        <ul>
            {% for p in result.potions %}
                <li>{{ p.name }}：消耗 {{ p.used }} 瓶，花費 {{ p.cost }} 金幣</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <script>
        function updatePotionInputs() {
            const all = document.querySelectorAll('input[name="potions"]');
            const selected = Array.from(all).filter(cb => cb.checked);
            const container = document.getElementById("potion-input-area");
            container.innerHTML = "";
            container.classList.add("hidden");
    
            all.forEach(cb => cb.disabled = selected.length >= 2 && !cb.checked);
    
            if (selected.length === 2) {
                const potionInfo = {
                    red:    { name: "紅色藥水", img: "/static/docs/red.png", defaultPrice: 50 },
                    orange: { name: "橘色藥水", img: "/static/docs/orange.png", defaultPrice: 160 },
                    white:  { name: "白色藥水", img: "/static/docs/white.png", defaultPrice: 320 },
                    blue:   { name: "藍色藥水", img: "/static/docs/blue.png", defaultPrice: 192 },
                    energy: { name: "活力藥水", img: "/static/docs/vigor.png", defaultPrice: 604 }
                };
    
                // 將後端傳來的表單值取出放入 JS（避免 Jinja 和 JS 混用）
                const formValues = {{ request.form|tojson }};
    
                selected.forEach(cb => {
                    const key = cb.value;
                    const p = potionInfo[key];
    
                    const startVal = formValues[`${key}_start`] || '';
                    const endVal = formValues[`${key}_end`] || '';
                    const priceVal = formValues[`${key}_price`] || p.defaultPrice;
    
                    const html = `
                        <div class="potion-block">
                            <img src="${p.img}" alt="${p.name}">
                            <div>
                                <strong>${p.name}</strong><br>
                                起始：<input type="number" name="${key}_start" value="${startVal}">
                                剩餘：<input type="number" name="${key}_end" value="${endVal}"><br>
                                單價：<input type="number" name="${key}_price" value="${priceVal}">
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML("beforeend", html);
                });
    
                container.classList.remove("hidden");
            }
        }
    
        window.addEventListener("DOMContentLoaded", function () {
            updatePotionInputs();
        });
    </script>
    
</div>
</body>
</html>
